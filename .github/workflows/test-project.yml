name: Тестирование контрольной работы

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  test:
    name: Сборка и тестирование проекта
    runs-on: ubuntu-latest

    steps:
    - name: Клонирование репозитория
      uses: actions/checkout@v4

    - name: Установка Java JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven

    - name: Установка MySQL
      run: |
        sudo systemctl start mysql.service
        mysql -e "SELECT VERSION();" -uroot -proot

    - name: Создание базы данных
      run: |
        mysql -uroot -proot < src/main/resources/init.sql
        mysql -uroot -proot -e "USE travel_db; SELECT COUNT(*) as 'Количество туристов' FROM tourists;"

    - name: Настройка подключения к БД
      run: |
        sed -i 's/db.password=root/db.password=root/g' src/main/resources/database.properties

    - name: Компиляция проекта с Maven
      run: |
        mvn clean compile

    - name: Запуск главного класса
      run: |
        mvn exec:java -Dexec.mainClass="by.bsuir.travel.Main" 2>&1 | tee full_output.txt
        cat full_output.txt | \
        grep -v "^\[INFO\]" | \
        grep -v "^\[WARNING\]" | \
        grep -v "^Download" | \
        grep -v "^Progress" | \
        sed '/^$/N;/^\n$/D' > clean_output.txt

    - name: Создание отчета о выполнении
      run: |
        cat > CONTROL_WORK_REPORT.txt << 'EOF'
        ================================================================================
                          ОТЧЕТ О ВЫПОЛНЕНИИ КОНТРОЛЬНОЙ РАБОТЫ
                                      ВАРИАНТ 5
        ================================================================================

        Дисциплина: Технологии программирования инфокоммуникационных систем (Часть 2)
        Тема: Туристическое агентство - Управление базой данных клиентов
        Дата выполнения: EOF
        date '+%d.%m.%Y %H:%M:%S' >> CONTROL_WORK_REPORT.txt
        cat >> CONTROL_WORK_REPORT.txt << 'EOF'

        ================================================================================
                                  ЗАДАНИЕ ВАРИАНТА 5
        ================================================================================

        Реализовать паттерн DAO (Data Access Object) для управления данными
        туристического агентства с использованием JDBC и MySQL.

        ТРЕБУЕМЫЕ МЕТОДЫ:

        1. Travel findEntityById(int id)
           Назначение: Поиск туриста в БД по уникальному идентификатору
           Параметр: id - идентификатор туриста
           Возвращает: объект Travel или null

        2. List<Travel> findAll()
           Назначение: Получение списка всех туристов из базы данных
           Возвращает: список объектов Travel

        3. boolean delete(int id)
           Назначение: Удаление туриста из БД по идентификатору
           Параметр: id - идентификатор туриста
           Возвращает: true если удаление успешно, иначе false

        4. boolean delete(Travel tourist)
           Назначение: Удаление туриста из БД по объекту
           Параметр: tourist - объект туриста для удаления
           Возвращает: true если удаление успешно, иначе false

        5. boolean create(Travel tourist)
           Назначение: Добавление нового туриста в базу данных
           Параметр: tourist - объект нового туриста
           Возвращает: true если создание успешно, иначе false

        6. Travel update(Travel tourist)
           Назначение: Обновление данных существующего туриста
           Параметр: tourist - объект туриста с обновленными данными
           Возвращает: обновленный объект Travel или null

        ================================================================================
                              ДЕМОНСТРАЦИЯ РАБОТЫ ПРОГРАММЫ
        ================================================================================

        EOF
        cat clean_output.txt >> CONTROL_WORK_REPORT.txt
        cat >> CONTROL_WORK_REPORT.txt << 'EOF'

        ================================================================================
                                    РЕЗУЛЬТАТЫ ВЫПОЛНЕНИЯ
        ================================================================================

        Все 6 методов TravelDAO успешно реализованы и протестированы
        Методы работают корректно с базой данных MySQL
        Используется PreparedStatement для защиты от SQL-инъекций
        Реализован паттерн DAO для абстракции работы с БД
        Все соединения с БД корректно закрываются (try-with-resources)

        ================================================================================
                                         ЗАКЛЮЧЕНИЕ
        ================================================================================

        Контрольная работа по варианту 5 выполнена в полном объеме.
        Все требуемые методы реализованы и успешно протестированы.
        Программа готова к демонстрации преподавателю.

        Студент: БГУИР

        ================================================================================
        EOF

    - name: Загрузка отчета как артефакт
      uses: actions/upload-artifact@v4
      with:
        name: Control-Work-Report-Variant-5-${{ github.run_number }}
        path: |
          CONTROL_WORK_REPORT.txt
          clean_output.txt
        retention-days: 90

    - name: Вывод статистики и итогов
      run: |
        echo ""
        echo "==============================================="
        echo "КОНТРОЛЬНАЯ РАБОТА - ВАРИАНТ 5"
        echo "Туристическое агентство - ВЫПОЛНЕНО"
        echo "==============================================="
        echo ""
        echo "Статистика базы данных:"
        mysql -uroot -proot -e "USE travel_db;
        SELECT 'Всего туристов:' as 'Параметр', COUNT(*) as 'Значение' FROM tourists
        UNION ALL
        SELECT 'Средняя цена тура:', ROUND(AVG(price), 2) FROM tourists
        UNION ALL
        SELECT 'Средняя длительность:', ROUND(AVG(duration_days), 1) FROM tourists;"
        echo ""
