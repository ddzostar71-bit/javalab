name: Laboratory Work 3 - Run

on:
  workflow_dispatch:
    inputs:
      task_number:
        description: 'Номер задания (1-5) или 0 для выхода'
        required: true
        default: '1'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
          - '5'
      login:
        description: 'Логин (для задания 5)'
        required: false
        default: 'user_123'
      password:
        description: 'Пароль (для задания 5)'
        required: false
        default: 'password_123'
      confirm_password:
        description: 'Подтверждение пароля (для задания 5)'
        required: false
        default: 'password_123'

jobs:
  run-lab3:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout код
        uses: actions/checkout@v4

      - name: ☕ Установка Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: 📊 Информация о системе
        run: |
          echo "================================"
          echo "ИНФОРМАЦИЯ О СИСТЕМЕ"
          echo "================================"
          echo "🖥️  ОС: $(uname -a)"
          echo "☕ Java версия:"
          java -version
          echo "📅 Дата и время: $(date)"
          echo "👤 Пользователь: $(whoami)"
          echo "📂 Рабочая директория: $(pwd)"
          echo "================================"

      - name: 📋 Информация о задании
        run: |
          TASK=${{ github.event.inputs.task_number }}
          echo ""
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║         ЛАБОРАТОРНАЯ РАБОТА 3 - ЗАДАНИЕ $TASK              ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          echo ""
          echo "📝 Описание задания:"
          case $TASK in
            1)
              echo "   Название: Наследование - Student и Magistracy"
              echo "   Описание: Демонстрация полиморфизма и наследования"
              echo "   Концепции: переопределение методов, полиморфизм"
              echo "   Особенности: расчет стипендии для студентов и магистрантов"
              ;;
            2)
              echo "   Название: Композиция - Car, Lorry, SportCar"
              echo "   Описание: Демонстрация композиции и наследования"
              echo "   Концепции: has-a отношения, иерархия классов"
              echo "   Классы: Person, Driver, Engine, Car и наследники"
              ;;
            3)
              echo "   Название: Абстрактные классы - Фрукты"
              echo "   Описание: Работа с абстрактными классами"
              echo "   Концепции: абстрактные методы, Template Method"
              echo "   Функции: расчет стоимости фруктов по весу"
              ;;
            4)
              echo "   Название: Интерфейсы - Printable"
              echo "   Описание: Использование интерфейсов"
              echo "   Концепции: контракты, instanceof, фильтрация"
              echo "   Классы: Book, Magazine реализующие Printable"
              ;;
            5)
              echo "   Название: Пользовательские исключения"
              echo "   Описание: Валидация данных с обработкой исключений"
              echo "   Концепции: создание исключений, множественные catch"
              echo "   🔐 Данные для валидации:"
              echo "      - Логин: ${{ github.event.inputs.login }}"
              echo "      - Пароль: ${{ github.event.inputs.password }}"
              echo "      - Подтверждение: ${{ github.event.inputs.confirm_password }}"
              ;;
          esac
          echo ""

      - name: 🔨 Компиляция программы
        run: |
          echo "════════════════════════════════════════════════════════════"
          echo "ЭТАП 1: КОМПИЛЯЦИЯ"
          echo "════════════════════════════════════════════════════════════"
          cd lab
          echo "📁 Компилируемый файл: LaboratoryWork3.java"
          echo "⏳ Начало компиляции..."
          javac -verbose LaboratoryWork3.java 2>&1 | head -20
          echo ""
          if [ -f "LaboratoryWork3.class" ]; then
            echo "✅ Компиляция успешно завершена!"
            echo "📦 Созданные файлы:"
            ls -lh LaboratoryWork3*.class 2>/dev/null || ls -lh *.class | grep "LaboratoryWork3"
            echo ""
            echo "📊 Количество скомпилированных классов:"
            ls -1 LaboratoryWork3*.class 2>/dev/null | wc -l
          else
            echo "❌ Ошибка компиляции!"
            exit 1
          fi
          echo "════════════════════════════════════════════════════════════"

      - name: 📝 Подготовка входных данных
        id: prepare_input
        run: |
          TASK=${{ github.event.inputs.task_number }}

          echo "════════════════════════════════════════════════════════════"
          echo "ЭТАП 2: ПОДГОТОВКА ВХОДНЫХ ДАННЫХ"
          echo "════════════════════════════════════════════════════════════"

          case $TASK in
            1|2|3|4)
              echo "📥 Входные данные для задания $TASK:"
              echo "   - Номер задания: $TASK"
              echo "   - Дополнительный ввод: не требуется (демонстрация)"
              echo "$TASK" > input.txt
              echo "0" >> input.txt
              ;;
            5)
              echo "📥 Входные данные для задания 5 (Валидация):"
              echo "   - Номер задания: $TASK"
              echo "   - Логин: ${{ github.event.inputs.login }}"
              echo "   - Пароль: ${{ github.event.inputs.password }}"
              echo "   - Подтверждение: ${{ github.event.inputs.confirm_password }}"
              echo ""
              echo "🔍 Правила валидации:"
              echo "   ✓ Логин: только латиница, цифры, подчеркивание, длина < 20"
              echo "   ✓ Пароль: только латиница, цифры, подчеркивание, длина < 20"
              echo "   ✓ Пароль должен совпадать с подтверждением"
              echo "$TASK" > input.txt
              echo "${{ github.event.inputs.login }}" >> input.txt
              echo "${{ github.event.inputs.password }}" >> input.txt
              echo "${{ github.event.inputs.confirm_password }}" >> input.txt
              echo "0" >> input.txt
              ;;
          esac

          echo ""
          echo "📄 Содержимое файла input.txt:"
          cat input.txt | nl
          echo "════════════════════════════════════════════════════════════"

      - name: 🚀 Запуск программы
        run: |
          cd lab
          echo ""
          echo "════════════════════════════════════════════════════════════"
          echo "ЭТАП 3: ВЫПОЛНЕНИЕ ПРОГРАММЫ"
          echo "════════════════════════════════════════════════════════════"
          echo "⏰ Время начала: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "▶️  ВЫВОД ПРОГРАММЫ:"
          echo "────────────────────────────────────────────────────────────"

          START_TIME=$(date +%s)
          java LaboratoryWork3 < ../input.txt 2>&1 | tee ../output.log || true
          END_TIME=$(date +%s)

          echo "────────────────────────────────────────────────────────────"
          DURATION=$((END_TIME - START_TIME))
          echo ""
          echo "⏱️  Время выполнения: ${DURATION} секунд"
          echo "⏰ Время окончания: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "════════════════════════════════════════════════════════════"

      - name: 📊 Статистика выполнения
        if: always()
        run: |
          echo ""
          echo "════════════════════════════════════════════════════════════"
          echo "СТАТИСТИКА ВЫПОЛНЕНИЯ"
          echo "════════════════════════════════════════════════════════════"
          echo "📌 Задание: ${{ github.event.inputs.task_number }}"
          echo "📅 Дата: $(date '+%Y-%m-%d')"
          echo "🕐 Время: $(date '+%H:%M:%S')"
          echo "✅ Статус: Выполнено"
          echo ""
          if [ -f output.log ]; then
            LINES=$(wc -l < output.log)
            echo "📝 Строк вывода: $LINES"
            echo "💾 Размер лога: $(du -h output.log | cut -f1)"
          fi
          echo ""
          echo "🎯 Концепции ООП в задании ${{ github.event.inputs.task_number }}:"
          case ${{ github.event.inputs.task_number }} in
            1)
              echo "   ✓ Наследование (extends)"
              echo "   ✓ Полиморфизм (переопределение методов)"
              echo "   ✓ Позднее связывание"
              ;;
            2)
              echo "   ✓ Композиция (has-a отношения)"
              echo "   ✓ Множественное наследование"
              echo "   ✓ Иерархия классов"
              ;;
            3)
              echo "   ✓ Абстрактные классы и методы"
              echo "   ✓ Template Method pattern"
              echo "   ✓ Работа с instanceof"
              ;;
            4)
              echo "   ✓ Интерфейсы"
              echo "   ✓ Контракты и implements"
              echo "   ✓ Проверка типов (instanceof)"
              ;;
            5)
              echo "   ✓ Пользовательские исключения"
              echo "   ✓ Множественные catch блоки"
              echo "   ✓ Регулярные выражения"
              ;;
          esac
          echo "════════════════════════════════════════════════════════════"

      - name: 📚 Проверка документации
        run: |
          echo ""
          echo "════════════════════════════════════════════════════════════"
          echo "ПРОВЕРКА ДОКУМЕНТАЦИИ"
          echo "════════════════════════════════════════════════════════════"
          if [ -f "lab/LAB3.md" ]; then
            echo "✅ Документация LAB3.md найдена"
            echo ""
            echo "📄 Первые 25 строк документации:"
            head -n 25 lab/LAB3.md
            echo ""
            SIZE=$(du -h lab/LAB3.md | cut -f1)
            LINES=$(wc -l < lab/LAB3.md)
            echo "💾 Размер документации: $SIZE"
            echo "📝 Количество строк: $LINES"
          else
            echo "⚠️  Документация LAB3.md не найдена"
          fi
          echo "════════════════════════════════════════════════════════════"

      - name: 💾 Сохранение логов выполнения
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lab3-task-${{ github.event.inputs.task_number }}-logs
          path: |
            output.log
            input.txt
            lab/LAB3.md
          retention-days: 30

      - name: ✅ Итоговый отчет
        if: always()
        run: |
          echo ""
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║                    ИТОГОВЫЙ ОТЧЕТ                         ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          echo ""
          echo "📋 Лабораторная работа: 3 (Продвинутое ООП)"
          echo "🔢 Номер задания: ${{ github.event.inputs.task_number }}"
          echo "📅 Дата выполнения: $(date '+%d.%m.%Y')"
          echo "🕐 Время выполнения: $(date '+%H:%M:%S')"
          echo "☕ Версия Java: 17"
          echo "💻 ОС: Ubuntu Latest"
          echo ""
          echo "🎓 Изученные концепции:"
          case ${{ github.event.inputs.task_number }} in
            1) echo "   • Наследование и полиморфизм";;
            2) echo "   • Композиция объектов";;
            3) echo "   • Абстрактные классы";;
            4) echo "   • Интерфейсы";;
            5) echo "   • Пользовательские исключения";;
          esac
          echo ""
          echo "✅ Все этапы выполнены успешно!"
          echo "📦 Артефакты (логи + документация) сохранены на 30 дней"
          echo "📥 Доступны для скачивания в разделе Artifacts"
          echo ""
          echo "════════════════════════════════════════════════════════════"
