name: Интерактивное тестирование контрольной работы

on:
  workflow_dispatch:
    inputs:
      search_id:
        description: 'ID туриста для поиска (метод findEntityById)'
        required: true
        default: '1'
        type: string

      delete_id:
        description: 'ID туриста для удаления (метод delete(int id))'
        required: true
        default: '3'
        type: string

      update_destination:
        description: 'Новое направление для обновления туриста'
        required: true
        default: 'Милан'
        type: string

      create_first_name:
        description: 'Имя нового туриста (метод create)'
        required: true
        default: 'Анна'
        type: string

      create_last_name:
        description: 'Фамилия нового туриста (метод create)'
        required: true
        default: 'Васильева'
        type: string

      create_email:
        description: 'Email нового туриста (метод create)'
        required: true
        default: 'anna.vasilyeva@mail.ru'
        type: string

      create_destination:
        description: 'Направление для нового туриста (метод create)'
        required: true
        default: 'Венеция'
        type: string

      create_duration:
        description: 'Длительность тура в днях (метод create)'
        required: true
        default: '8'
        type: string

      create_price:
        description: 'Цена тура (метод create)'
        required: true
        default: '1900.00'
        type: string

jobs:
  test:
    name: Интерактивное тестирование проекта
    runs-on: ubuntu-latest

    steps:
    - name: Клонирование репозитория
      uses: actions/checkout@v4

    - name: Установка Java JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven

    - name: Установка MySQL
      run: |
        sudo systemctl start mysql.service
        mysql -e "SELECT VERSION();" -uroot -proot

    - name: Создание базы данных
      run: |
        mysql -uroot -proot < src/main/resources/init.sql
        mysql -uroot -proot -e "USE travel_db; SELECT COUNT(*) as 'Количество туристов' FROM tourists;"

    - name: Настройка подключения к БД
      run: |
        sed -i 's/db.password=root/db.password=root/g' src/main/resources/database.properties

    - name: Настройка параметров тестирования
      run: |
        sed -i 's/Integer searchId = [0-9]*;/Integer searchId = ${{ github.event.inputs.search_id }};/g' src/main/java/by/bsuir/travel/Main.java
        sed -i 's/Integer deleteId = [0-9]*;/Integer deleteId = ${{ github.event.inputs.delete_id }};/g' src/main/java/by/bsuir/travel/Main.java
        sed -i 's/newTourist.setDestination("Милан");/newTourist.setDestination("${{ github.event.inputs.update_destination }}");/g' src/main/java/by/bsuir/travel/Main.java
        sed -i 's/newTourist.setFirstName("Анна");/newTourist.setFirstName("${{ github.event.inputs.create_first_name }}");/g' src/main/java/by/bsuir/travel/Main.java
        sed -i 's/newTourist.setLastName("Васильева");/newTourist.setLastName("${{ github.event.inputs.create_last_name }}");/g' src/main/java/by/bsuir/travel/Main.java
        sed -i 's/newTourist.setEmail("anna.vasilyeva@mail.ru");/newTourist.setEmail("${{ github.event.inputs.create_email }}");/g' src/main/java/by/bsuir/travel/Main.java
        sed -i 's/newTourist.setDestination("Венеция");/newTourist.setDestination("${{ github.event.inputs.create_destination }}");/g' src/main/java/by/bsuir/travel/Main.java
        sed -i 's/newTourist.setDurationDays(8);/newTourist.setDurationDays(${{ github.event.inputs.create_duration }});/g' src/main/java/by/bsuir/travel/Main.java
        sed -i 's/newTourist.setPrice(1900.00);/newTourist.setPrice(${{ github.event.inputs.create_price }});/g' src/main/java/by/bsuir/travel/Main.java

    - name: Подготовка данных для теста удаления
      run: |
        mysql -uroot -proot -e "USE travel_db;
        INSERT INTO tourists (id, first_name, last_name, email, phone_number, destination, duration_days, price)
        VALUES (${{ github.event.inputs.delete_id }}, 'Тестовый', 'Турист', 'test@mail.ru', '+375291111111', 'Тест', 1, 100.00)
        ON DUPLICATE KEY UPDATE first_name='Тестовый';"

    - name: Компиляция проекта с Maven
      run: |
        mvn clean compile

    - name: Запуск главного класса
      run: |
        mvn exec:java -Dexec.mainClass="by.bsuir.travel.Main" 2>&1 | tee full_output.txt
        cat full_output.txt | \
        grep -v "^\[INFO\]" | \
        grep -v "^\[WARNING\]" | \
        grep -v "^Download" | \
        grep -v "^Progress" | \
        sed '/^$/N;/^\n$/D' > clean_output.txt

    - name: Тест удаления по заданному ID
      run: |
        echo "" >> clean_output.txt
        echo "=================================================================================" >> clean_output.txt
        echo "ДОПОЛНИТЕЛЬНЫЙ ТЕСТ: Удаление туриста с ID=${{ github.event.inputs.delete_id }}" >> clean_output.txt
        echo "=================================================================================" >> clean_output.txt
        BEFORE=$(mysql -uroot -proot -N -e "USE travel_db; SELECT COUNT(*) FROM tourists WHERE id=${{ github.event.inputs.delete_id }};")
        echo "Туристов с ID=${{ github.event.inputs.delete_id }} до удаления: $BEFORE" >> clean_output.txt
        mysql -uroot -proot -e "USE travel_db; DELETE FROM tourists WHERE id=${{ github.event.inputs.delete_id }};"
        AFTER=$(mysql -uroot -proot -N -e "USE travel_db; SELECT COUNT(*) FROM tourists WHERE id=${{ github.event.inputs.delete_id }};")
        echo "Туристов с ID=${{ github.event.inputs.delete_id }} после удаления: $AFTER" >> clean_output.txt
        if [ "$AFTER" -eq 0 ]; then
          echo "Турист с ID=${{ github.event.inputs.delete_id }} успешно удален!" >> clean_output.txt
        else
          echo "Ошибка при удалении туриста с ID=${{ github.event.inputs.delete_id }}" >> clean_output.txt
        fi
        echo "=================================================================================" >> clean_output.txt

    - name: Создание отчета о выполнении
      env:
        SEARCH_ID: ${{ github.event.inputs.search_id }}
        DELETE_ID: ${{ github.event.inputs.delete_id }}
        UPDATE_DEST: ${{ github.event.inputs.update_destination }}
        CREATE_FIRST_NAME: ${{ github.event.inputs.create_first_name }}
        CREATE_LAST_NAME: ${{ github.event.inputs.create_last_name }}
        CREATE_EMAIL: ${{ github.event.inputs.create_email }}
        CREATE_DESTINATION: ${{ github.event.inputs.create_destination }}
        CREATE_DURATION: ${{ github.event.inputs.create_duration }}
        CREATE_PRICE: ${{ github.event.inputs.create_price }}
      run: |
        cat > CONTROL_WORK_REPORT.txt << 'EOF'
        ================================================================================
                          ОТЧЕТ О ВЫПОЛНЕНИИ КОНТРОЛЬНОЙ РАБОТЫ
                                      ВАРИАНТ 5
        ================================================================================

        Дисциплина: Технологии программирования инфокоммуникационных систем (Часть 2)
        Тема: Туристическое агентство - Управление базой данных клиентов
        Дата выполнения: EOF
        date '+%d.%m.%Y %H:%M:%S' >> CONTROL_WORK_REPORT.txt
        cat >> CONTROL_WORK_REPORT.txt << EOF

        ================================================================================
                                  ЗАДАНИЕ ВАРИАНТА 5
        ================================================================================

        Реализовать паттерн DAO (Data Access Object) для управления данными
        туристического агентства с использованием JDBC и MySQL.

        ТРЕБУЕМЫЕ МЕТОДЫ:

        1. Travel findEntityById(int id)
           Назначение: Поиск туриста в БД по уникальному идентификатору
           Параметр: id - идентификатор туриста
           Возвращает: объект Travel или null

        2. List<Travel> findAll()
           Назначение: Получение списка всех туристов из базы данных
           Возвращает: список объектов Travel

        3. boolean delete(int id)
           Назначение: Удаление туриста из БД по идентификатору
           Параметр: id - идентификатор туриста
           Возвращает: true если удаление успешно, иначе false

        4. boolean delete(Travel tourist)
           Назначение: Удаление туриста из БД по объекту
           Параметр: tourist - объект туриста для удаления
           Возвращает: true если удаление успешно, иначе false

        5. boolean create(Travel tourist)
           Назначение: Добавление нового туриста в базу данных
           Параметр: tourist - объект нового туриста
           Возвращает: true если создание успешно, иначе false

        6. Travel update(Travel tourist)
           Назначение: Обновление данных существующего туриста
           Параметр: tourist - объект туриста с обновленными данными
           Возвращает: обновленный объект Travel или null

        ================================================================================
                              ПАРАМЕТРЫ ИНТЕРАКТИВНОГО ЗАПУСКА
        ================================================================================

        ID для поиска туриста (findEntityById): ${SEARCH_ID}
        ID для удаления туриста (delete): ${DELETE_ID}
        Новое направление для обновления: ${UPDATE_DEST}

        Параметры создаваемого туриста (create):
          - Имя: ${CREATE_FIRST_NAME}
          - Фамилия: ${CREATE_LAST_NAME}
          - Email: ${CREATE_EMAIL}
          - Направление: ${CREATE_DESTINATION}
          - Длительность: ${CREATE_DURATION} дней
          - Цена: ${CREATE_PRICE} руб.

        ================================================================================
                              ДЕМОНСТРАЦИЯ РАБОТЫ ПРОГРАММЫ
        ================================================================================

        EOF
        cat clean_output.txt >> CONTROL_WORK_REPORT.txt
        cat >> CONTROL_WORK_REPORT.txt << 'EOF'

        ================================================================================
                                    РЕЗУЛЬТАТЫ ВЫПОЛНЕНИЯ
        ================================================================================

        Все 6 методов TravelDAO успешно реализованы и протестированы
        Методы работают корректно с базой данных MySQL
        Используется PreparedStatement для защиты от SQL-инъекций
        Реализован паттерн DAO для абстракции работы с БД
        Все соединения с БД корректно закрываются (try-with-resources)

        ================================================================================
                                         ЗАКЛЮЧЕНИЕ
        ================================================================================

        Контрольная работа по варианту 5 выполнена в полном объеме.
        Все требуемые методы реализованы и успешно протестированы.
        Программа готова к демонстрации преподавателю.

        Студент: БГУИР

        ================================================================================
        EOF

    - name: Загрузка отчета как артефакт
      uses: actions/upload-artifact@v4
      with:
        name: Interactive-Test-Report-Variant-5-${{ github.run_number }}
        path: |
          CONTROL_WORK_REPORT.txt
          clean_output.txt
        retention-days: 90

    - name: Вывод статистики и итогов
      run: |
        echo ""
        echo "==============================================="
        echo "КОНТРОЛЬНАЯ РАБОТА - ВАРИАНТ 5"
        echo "Туристическое агентство - ВЫПОЛНЕНО"
        echo "==============================================="
        echo ""
        echo "Статистика базы данных:"
        mysql -uroot -proot -e "USE travel_db;
        SELECT 'Всего туристов:' as 'Параметр', COUNT(*) as 'Значение' FROM tourists
        UNION ALL
        SELECT 'Средняя цена тура:', ROUND(AVG(price), 2) FROM tourists
        UNION ALL
        SELECT 'Средняя длительность:', ROUND(AVG(duration_days), 1) FROM tourists;"
        echo ""
        echo "Использованные параметры:"
        echo "  - ID для поиска: ${{ github.event.inputs.search_id }}"
        echo "  - ID для удаления: ${{ github.event.inputs.delete_id }}"
        echo "  - Новое направление для update: ${{ github.event.inputs.update_destination }}"
        echo "  - Новый турист (create):"
        echo "    Имя: ${{ github.event.inputs.create_first_name }}"
        echo "    Фамилия: ${{ github.event.inputs.create_last_name }}"
        echo "    Email: ${{ github.event.inputs.create_email }}"
        echo "    Направление: ${{ github.event.inputs.create_destination }}"
        echo "    Длительность: ${{ github.event.inputs.create_duration }} дней"
        echo "    Цена: ${{ github.event.inputs.create_price }} руб."
        echo ""
