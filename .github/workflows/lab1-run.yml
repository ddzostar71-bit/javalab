name: Laboratory Work 1 - Run

on:
  workflow_dispatch:
    inputs:
      task_number:
        description: 'Номер задания (1-13) или 0 для выхода'
        required: true
        default: '1'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
          - '5'
          - '6'
          - '7'
          - '8'
          - '9'
          - '10'
          - '11'
          - '12'
          - '13'
      task_input:
        description: 'Входные данные для задания (если требуются)'
        required: false
        default: ''

jobs:
  run-lab1:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout код
        uses: actions/checkout@v4

      - name: ☕ Установка Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: 📊 Информация о системе
        run: |
          echo "================================"
          echo "ИНФОРМАЦИЯ О СИСТЕМЕ"
          echo "================================"
          echo "🖥️  ОС: $(uname -a)"
          echo "☕ Java версия:"
          java -version
          echo "📅 Дата и время: $(date)"
          echo "👤 Пользователь: $(whoami)"
          echo "📂 Рабочая директория: $(pwd)"
          echo "================================"

      - name: 📋 Информация о задании
        run: |
          TASK=${{ github.event.inputs.task_number }}
          echo ""
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║         ЛАБОРАТОРНАЯ РАБОТА 1 - ЗАДАНИЕ $TASK              ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          echo ""
          echo "📝 Описание задания:"
          case $TASK in
            1)
              echo "   Название: Степени числа"
              echo "   Описание: Выводит первые четыре степени заданного числа"
              echo "   Входные данные: число n"
              ;;
            2)
              echo "   Название: Проверка пароля"
              echo "   Описание: Запрашивает пароль до правильного ввода (1234)"
              ;;
            3)
              echo "   Название: Сумма n-значных чисел"
              echo "   Описание: Находит сумму всех n-значных чисел (1 ≤ n ≤ 4)"
              ;;
            4)
              echo "   Название: Угадай число"
              echo "   Описание: Игра на угадывание числа от 1 до 10 с подсказками"
              ;;
            5)
              echo "   Название: Последовательность чисел"
              echo "   Описание: Выводит последовательность 1000, 1003, 1006..."
              ;;
            6)
              echo "   Название: Последовательность Фибоначчи"
              echo "   Описание: Первые 11 членов последовательности Фибоначчи"
              ;;
            7)
              echo "   Название: Счастливые билеты"
              echo "   Описание: Подсчет билетов где сумма первых 3 цифр = сумме последних 3"
              ;;
            8)
              echo "   Название: Проверка попадания в интервал"
              echo "   Описание: Проверяет попадание случайного числа [5;155] в (25;100)"
              ;;
            9)
              echo "   Название: Конвертер секунд"
              echo "   Описание: Преобразует секунды в часы с правильным склонением"
              ;;
            10)
              echo "   Название: Максимальный элемент массива"
              echo "   Описание: Поиск максимума и его последнего вхождения в массиве"
              ;;
            11)
              echo "   Название: Массивы с четными элементами"
              echo "   Описание: Фильтрация четных чисел из массива"
              ;;
            12)
              echo "   Название: Примеры из таблицы умножения"
              echo "   Описание: Генерация 15 уникальных примеров 2×2 до 9×9"
              ;;
            13)
              echo "   Название: Матрица с заменой элементов"
              echo "   Описание: Замена min/max элементов в каждой строке матрицы"
              ;;
          esac
          echo ""

      - name: 🔨 Компиляция программы
        run: |
          echo "════════════════════════════════════════════════════════════"
          echo "ЭТАП 1: КОМПИЛЯЦИЯ"
          echo "════════════════════════════════════════════════════════════"
          cd lab
          echo "📁 Компилируемый файл: LaboratoryWork1.java"
          echo "⏳ Начало компиляции..."
          javac -verbose LaboratoryWork1.java 2>&1 | head -20
          echo ""
          if [ -f "LaboratoryWork1.class" ]; then
            echo "✅ Компиляция успешно завершена!"
            echo "📦 Созданные файлы:"
            ls -lh *.class | head -10
          else
            echo "❌ Ошибка компиляции!"
            exit 1
          fi
          echo "════════════════════════════════════════════════════════════"

      - name: 📝 Подготовка входных данных
        id: prepare_input
        run: |
          TASK=${{ github.event.inputs.task_number }}
          INPUT="${{ github.event.inputs.task_input }}"

          echo "════════════════════════════════════════════════════════════"
          echo "ЭТАП 2: ПОДГОТОВКА ВХОДНЫХ ДАННЫХ"
          echo "════════════════════════════════════════════════════════════"

          # Формируем входные данные в зависимости от задания
          case $TASK in
            1)
              if [ -z "$INPUT" ]; then INPUT="5"; fi
              echo "📥 Входные данные для задания 1:"
              echo "   - Номер задания: $TASK"
              echo "   - Число для возведения в степень: $INPUT"
              echo "$TASK" > input.txt
              echo "$INPUT" >> input.txt
              echo "0" >> input.txt
              ;;
            2)
              echo "📥 Входные данные для задания 2:"
              echo "   - Номер задания: $TASK"
              echo "   - Пароль: 1234 (автоматически)"
              echo "$TASK" > input.txt
              echo "1234" >> input.txt
              echo "0" >> input.txt
              ;;
            3)
              if [ -z "$INPUT" ]; then INPUT="2"; fi
              echo "📥 Входные данные для задания 3:"
              echo "   - Номер задания: $TASK"
              echo "   - Количество цифр (n): $INPUT"
              echo "$TASK" > input.txt
              echo "$INPUT" >> input.txt
              echo "0" >> input.txt
              ;;
            4)
              echo "📥 Входные данные для задания 4:"
              echo "   - Номер задания: $TASK"
              echo "   - Попытки угадывания: 1-10 (перебор)"
              echo "$TASK" > input.txt
              for i in {1..10}; do echo "$i" >> input.txt; done
              echo "0" >> input.txt
              ;;
            5|6|7|8|9|10)
              echo "📥 Входные данные для задания $TASK:"
              echo "   - Номер задания: $TASK"
              echo "   - Дополнительный ввод: не требуется"
              echo "$TASK" > input.txt
              echo "0" >> input.txt
              ;;
            11)
              if [ -z "$INPUT" ]; then INPUT="10"; fi
              echo "📥 Входные данные для задания 11:"
              echo "   - Номер задания: $TASK"
              echo "   - Размер массива: $INPUT"
              echo "$TASK" > input.txt
              echo "$INPUT" >> input.txt
              echo "0" >> input.txt
              ;;
            12|13)
              echo "📥 Входные данные для задания $TASK:"
              echo "   - Номер задания: $TASK"
              echo "   - Дополнительный ввод: не требуется"
              echo "$TASK" > input.txt
              echo "0" >> input.txt
              ;;
          esac

          echo ""
          echo "📄 Содержимое файла input.txt:"
          cat input.txt | nl
          echo "════════════════════════════════════════════════════════════"

      - name: 🚀 Запуск программы
        run: |
          cd lab
          echo ""
          echo "════════════════════════════════════════════════════════════"
          echo "ЭТАП 3: ВЫПОЛНЕНИЕ ПРОГРАММЫ"
          echo "════════════════════════════════════════════════════════════"
          echo "⏰ Время начала: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "▶️  ВЫВОД ПРОГРАММЫ:"
          echo "────────────────────────────────────────────────────────────"

          START_TIME=$(date +%s)
          java LaboratoryWork1 < ../input.txt 2>&1 | tee ../output.log || true
          END_TIME=$(date +%s)

          echo "────────────────────────────────────────────────────────────"
          DURATION=$((END_TIME - START_TIME))
          echo ""
          echo "⏱️  Время выполнения: ${DURATION} секунд"
          echo "⏰ Время окончания: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "════════════════════════════════════════════════════════════"

      - name: 📊 Статистика выполнения
        if: always()
        run: |
          echo ""
          echo "════════════════════════════════════════════════════════════"
          echo "СТАТИСТИКА ВЫПОЛНЕНИЯ"
          echo "════════════════════════════════════════════════════════════"
          echo "📌 Задание: ${{ github.event.inputs.task_number }}"
          echo "📅 Дата: $(date '+%Y-%m-%d')"
          echo "🕐 Время: $(date '+%H:%M:%S')"
          echo "✅ Статус: Выполнено"
          echo ""
          if [ -f output.log ]; then
            LINES=$(wc -l < output.log)
            echo "📝 Строк вывода: $LINES"
            echo "💾 Размер лога: $(du -h output.log | cut -f1)"
          fi
          echo "════════════════════════════════════════════════════════════"

      - name: 💾 Сохранение логов выполнения
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lab1-task-${{ github.event.inputs.task_number }}-logs
          path: |
            output.log
            input.txt
          retention-days: 30

      - name: ✅ Итоговый отчет
        if: always()
        run: |
          echo ""
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║                    ИТОГОВЫЙ ОТЧЕТ                         ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          echo ""
          echo "📋 Лабораторная работа: 1"
          echo "🔢 Номер задания: ${{ github.event.inputs.task_number }}"
          echo "📅 Дата выполнения: $(date '+%d.%m.%Y')"
          echo "🕐 Время выполнения: $(date '+%H:%M:%S')"
          echo "☕ Версия Java: 17"
          echo "💻 ОС: Ubuntu Latest"
          echo ""
          echo "✅ Все этапы выполнены успешно!"
          echo "📦 Артефакты сохранены и доступны для скачивания"
          echo ""
          echo "════════════════════════════════════════════════════════════"
